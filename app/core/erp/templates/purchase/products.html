{% extends 'purchase/base_purchase.html' %}
{% load static %}

{% block head_list %}

<!-- =================== LIBRERÃAS =================== -->
<link href="{% static 'lib/jquery-ui-1.14.1.custom/jquery-ui.min.css' %}" rel="stylesheet">
<script src="{% static 'lib/jquery-ui-1.14.1.custom/jquery-ui.min.js' %}"></script>

<link href="{% static 'lib/select2-4.0.13/css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'lib/select2-4.0.13/js/select2.min.js' %}"></script>

<link href="{% static 'lib/bootstrap-touchspin/css/jquery.bootstrap-touchspin.css' %}" rel="stylesheet">
<script src="{% static 'lib/bootstrap-touchspin/js/jquery.bootstrap-touchspin.js' %}"></script>

<script src="{% static 'js/functions.js' %}"></script>

<!-- =================== ESTILOS =================== -->
<style>
    .purchase-info-card {
        background: #f8fbff;
        border: 1px solid #dce7f5;
        border-radius: 10px;
        padding: 18px 25px;
        margin-bottom: 25px;
    }

    .purchase-info-title {
        display: flex;
        align-items: center;
        font-size: 18px;
        color: #007bff;
        font-weight: 600;
        margin-bottom: 15px;
        gap: 10px;
    }

    .purchase-label {
        font-size: 13px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
    }

    .purchase-value {
        font-size: 15px;
        font-weight: bold;
        color: #34495e;
    }

    /* Panel izquierdo */
    .form-panel {
        width: 380px;
        background: #ffffff;
        border: 1px solid #dce7f5;
        border-radius: 12px;
        padding: 22px 20px;
        box-shadow: 0 3px 12px rgba(0,0,0,0.06);
        margin-top: 20px;          /* ðŸ‘ˆ bajamos SOLO el panel izquierdo */
    }

    .form-panel input {
        height: 38px;
        border-radius: 7px;
        border: 1px solid #cbd6e2;
        font-size: 14px;
    }

    .form-panel label {
        font-weight: 600;
        color: #374151;
        font-size: 14px;
    }

    /* Tabla derecha */
    .table-panel {
        flex-grow: 1;
        max-width: calc(100% - 400px);
        margin-top: 0;             /* ðŸ‘ˆ la tabla se queda arriba */
    }

    .table-wrapper {
        height: 470px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #d5e0ed;
        border-radius: 10px;
        background: white;
        padding-right: 6px;
    }

    .table-wrapper table {
        margin-bottom: 0 !important;
        table-layout: fixed;
    }

    .table-wrapper thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(90deg,#007bff,#009dff) !important;
        color: white !important;
        font-weight: bold;
        z-index: 30;
    }

    #tableProducts input {
        width: 100%;
        height: 34px;
        font-size: 13px;
        border-radius: 6px;
        border: 1px solid #cbd6e2;
        padding: 4px 6px;
    }

    /* Columna Producto mÃ¡s estrecha con texto recortado */
    #tableProducts th.col-product,
    #tableProducts td.col-product {
        width: 280px;
        max-width: 280px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>


<!-- =================== JS LÃ“GICA =================== -->
<script>
let tableProducts = null;

const items = {
    products: []
};

/* ========== CALCULAR TOTAL DE UNIDADES ========== */
function calculate() {
    let totalQty = 0;
    items.products.forEach(p => {
        totalQty += p.quantity || 0;
    });
    $("#total_unidades").text(totalQty);
}

/* ========== RENDERIZAR TABLA ========== */
function renderTable() {

    if (tableProducts) {
        tableProducts.destroy();
    }

    tableProducts = $("#tableProducts").DataTable({
        data: items.products,
        destroy: true,
        autoWidth: false,
        paging: false,
        searching: false,
        info: false,
        ordering: false,

        columns: [
            { data: null },      // Nro
            { data: "name" },    // Producto
            { data: "quantity" },// Cantidad
            { data: null }       // Acciones
        ],

        columnDefs: [
            {
                targets: 0,
                className: "text-center",
                render: function (data, type, row, meta) {
                    return meta.row + 1;
                }
            },
            {
                // ðŸ‘‰ columna Producto con clase para el ancho fijo
                targets: 1,
                className: "col-product"
            },
            {
                targets: 2,
                render: function (data, type, row) {
                    return `
                        <input type="number" 
                               class="form-control form-control-sm input-qty" 
                               min="1"
                               value="${row.quantity}">
                    `;
                }
            },
            {
                targets: 3,
                className: "text-center",
                render: function () {
                    return `
                        <button class="btn btn-danger btn-sm btnRemove">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        ]
    });

    // ----- eventos de la tabla -----
    $("#tableProducts tbody").off();

    // eliminar fila
    $("#tableProducts tbody").on("click", ".btnRemove", function () {
        const index = tableProducts.row($(this).parents("tr")).index();
        items.products.splice(index, 1);
        renderTable();
        calculate();
    });

    // cambiar cantidad
    $("#tableProducts tbody").on("keyup change", ".input-qty", function () {
        const index = tableProducts.row($(this).closest("tr")).index();
        items.products[index].quantity = parseInt($(this).val()) || 0;
        calculate();
    });

    calculate();
}

/* ========== DOCUMENT READY ========== */
$(function () {

    // ---------- AUTOCOMPLETE PRODUCTO ----------
    $('input[name="search"]').autocomplete({
        source: function (req, res) {
            $.ajax({
                url: window.location.pathname,
                type: "POST",
                data: { action: "search_products", term: req.term },
                dataType: "json",
                success: res
            });
        },
        select: function (event, ui) {
            event.preventDefault();
            $('input[name="search"]').val(ui.item.name);
            $("#qty").val(1);
            $("#product_id").val(ui.item.id);
        }
    });

    // ---------- BOTÃ“N AGREGAR ----------
    $("#btnAdd").on("click", function () {
        const prodId = $("#product_id").val();
        const prodName = $('input[name="search"]').val().trim();
        const qty = parseInt($("#qty").val()) || 0;

        if (!prodId || !prodName) {
            Swal.fire("Error", "Seleccione un producto.", "error");
            return;
        }

        if (qty <= 0) {
            Swal.fire("Error", "La cantidad debe ser mayor a 0.", "error");
            return;
        }

        const existing = items.products.find(p => p.id === parseInt(prodId));
        if (existing) {
            existing.quantity += qty;
        } else {
            items.products.push({
                id: parseInt(prodId),
                name: prodName,
                quantity: qty
            });
        }

        $('input[name="search"]').val("");
        $("#qty").val(1);
        $("#product_id").val("");

        renderTable();
    });

    // ---------- BOTÃ“N GUARDAR PRODUCTOS ----------
    $("#btnSave").on("click", function () {

        if (!items.products.length) {
            Swal.fire("Error","Debe agregar al menos un producto.","error");
            return;
        }

        $.ajax({
            url: window.location.pathname,
            type: "POST",
            data: {
                action: "add_details",
                details: JSON.stringify(items.products)
            },
            dataType: "json",
            success: function (data) {
                if (data.error) {
                    Swal.fire("Error", data.error, "error");
                } else {
                    Swal.fire("Correcto", data.success, "success")
                        .then(() => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            }
                        });
                }
            },
            error: function () {
                Swal.fire("Error", "OcurriÃ³ un error al guardar los productos.", "error");
            }
        });
    });

});
</script>

{% endblock %}

{% block content %}

<!-- ======= PASO 1 ======= -->
<div class="purchase-info-card">
    <div class="purchase-info-title">
        <i class="fas fa-check-circle"></i>
        <span>Compra creada</span>
    </div>

    <div class="row text-left">
        <div class="col-md-3 mb-2">
            <div class="purchase-label">Proveedor</div>
            <div class="purchase-value">{{ purchase.provider.company }}</div>
        </div>

        <div class="col-md-3 mb-2">
            <div class="purchase-label">Fecha de compra</div>
            <div class="purchase-value">{{ purchase.date }}</div>
        </div>

        <div class="col-md-3 mb-2">
            <div class="purchase-label">Estado</div>
            <div class="purchase-value">{{ purchase.get_status_display }}</div>
        </div>

        <div class="col-md-3 mb-2">
            <div class="purchase-label">Observaciones</div>
            <div class="purchase-value">
                {{ purchase.observations|default:"Sin observaciones" }}
            </div>
        </div>
    </div>
</div>

<!-- ======= PASO 2 ======= -->
<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-boxes"></i> Paso 2 | Agregar productos
        </h3>
    </div>

    <div class="card-body">
        <div class="d-flex" style="gap: 35px; align-items: flex-start;">

            <!-- PANEL IZQUIERDO -->
            <div class="form-panel">
                <input type="hidden" id="product_id">

                <div class="form-group">
                    <label>Producto (*)</label>
                    <input type="text" name="search" class="form-control" placeholder="Buscar productoâ€¦">
                </div>

                <div class="form-group">
                    <label>Cantidad (*)</label>
                    <input type="number" id="qty" class="form-control" value="1" min="1">
                </div>

                <button id="btnAdd" class="btn btn-primary btn-block mt-3">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>

            <!-- TABLA DERECHA -->
            <div class="table-panel">
                <h5><b>Productos de la compra</b></h5>

                <div class="table-wrapper">
                    <table class="table table-bordered" id="tableProducts">
                        <thead>
                            <tr>
                                <th style="width:60px;">Nro</th>
                                <th class="col-product">Producto</th>
                                <th style="width:120px;">Cant.</th>
                                <th style="width:90px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h5 class="text-right mt-3">
                    <b>Total de productos:</b> <span id="total_unidades">0</span>
                </h5>
            </div>

        </div>
    </div>

    <div class="card-footer text-right">
        <button id="btnSave" class="btn btn-success">
            <i class="fas fa-save"></i> Guardar productos
        </button>
    </div>
</div>

{% endblock %}
